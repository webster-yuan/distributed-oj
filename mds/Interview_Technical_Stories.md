# 分布式 OJ 项目技术攻坚故事集 (STAR 法则)

本指南为面试准备，采用 STAR 法则（背景 - 任务 - 行动 - 结果）组织，涵盖了项目中的核心技术难点与解决方案。

---

## 故事一：利用 `setrlimit` 与多进程机制构建安全的沙箱运行环境

**背景 (Situation):**
在 OJ 系统中，最核心且最危险的部分是运行用户提交的代码。用户代码可能包含死循环、内存溢出（如申请巨大数组）甚至恶意系统调用，如果直接在服务器进程中运行，会导致服务器资源耗尽甚至崩溃。

**任务 (Task):**
我需要构建一个“沙箱”环境，严格限制用户程序的资源消耗（CPU 时间、内存占用），并确保用户程序的异常（如段错误、除0错误）不会影响到 OJ 服务端的正常运行。

**行动 (Action):**
1.  **进程隔离**：采用 `fork()` 创建子进程来执行用户代码，父进程负责监控。这样即使子进程崩溃，父进程也能通过 `waitpid` 捕获状态。
2.  **资源限制**：在子进程执行 `exec` 替换程序之前，调用 `setrlimit` 系统调用。设置了 `RLIMIT_CPU` 来限制执行时长，防止死循环；设置 `RLIMIT_AS` 限制虚拟内存大小，防止内存暴涨。
3.  **标准流重定向**：利用 `dup2` 将子进程的标准输入、输出、错误重定向到特定的临时文件中，以便后续读取运行结果。
4.  **状态捕获**：父进程通过 `WIFSIGNALED` 和 `WTERMSIG` 宏解析子进程的退出状态，将 `SIGXCPU`（超时）、`SIGABRT`（内存超限）、`SIGFPE`（算术异常）等信号转换为友好的错误信息返回给前端。

**结果 (Result):**
成功实现了用户代码的隔离运行。系统能够精准识别并拦截 99% 以上的恶意代码或异常程序，保证了编译服务器 7*24 小时稳定运行，单机可承受的并发运行请求提升了约 3 倍，且从未因用户代码问题导致主进程宕机。

---

## 故事二：设计并实现基于负载均衡的分布式编译架构

**背景 (Situation):**
随着用户量增加，单台编译服务器的 CPU 压力剧增，编译和运行代码是计算密集型任务，单机架构成为了系统的性能瓶颈。

**任务 (Task):**
设计一套分布式架构，引入多台编译后端，并实现一个智能的负载均衡算法，将任务合理分配到不同的机器上，同时具备自动容错能力。

**行动 (Action):**
1.  **负载均衡器设计**：在 `oj_server` 中实现 `LoadBalance` 模块，通过配置文件动态管理后端机器列表。
2.  **多维负载算法**：从简单的轮询优化为“最小负载优先”。在 `Machine` 类中实现了 `UpdateStatus` 接口，通过 HTTP 请求实时获取后端的 CPU、内存、响应时间等数据，计算综合权重。
3.  **热插拔与容错**：设计了在线（Online）和离线（Offline）队列。当某台后端请求失败时，负载均衡器会自动将其剔除并放入离线队列，同时支持通过管理接口一键恢复所有离线机器。
4.  **并发安全**：使用 `std::mutex` 保护机器列表和负载数据，确保在多线程环境下任务分配的准确性。

**结果 (Result):**
实现了系统的水平扩展。在多台编译后端的测试环境下，系统整体吞吐量（TPS）显著提升。当某台后端宕机时，系统能自动完成切换，用户端无感知，极大地提高了系统的可用性和鲁棒性。

---

## 故事三：解决高并发下的临时文件冲突与清理问题

**背景 (Situation):**
在 OJ 系统运行过程中，每份代码的编译和运行都会产生大量的临时文件（`.cpp`, `.exe`, `.stdout` 等）。在高并发场景下，如果文件名冲突会导致数据串扰，且如果清理不及时，磁盘空间会迅速耗尽。

**任务 (Task):**
设计一套唯一文件名生成机制，并确保在各种异常情况下（包括程序崩溃、逻辑报错）临时文件都能被彻底清理。

**行动 (Action):**
1.  **唯一性保证**：实现 `UniqFileName` 函数，采用“毫秒级时间戳 + 原子递增计数器”的组合，确保在极高并发下生成的文件名绝对唯一。
2.  **统一清理逻辑**：在 `CompileAndRun::Start` 函数中采用统一的出口管理，无论在哪个环节（代码为空、编译失败、运行报错）出错，都会通过 `RemoveTempFile` 销毁所有相关临时文件。
3.  **健壮性处理**：在清理函数中，对每一个可能的文件路径进行存在性检查后再调用 `unlink`，确保清理过程不会因为部分文件未生成而中断或报错。

**结果 (Result):**
彻底解决了高并发下的数据覆盖问题，系统在模拟高并发提交测试中未出现一例文件冲突。同时，磁盘空间占用始终保持在健康水平，确保了系统的长期稳定运行。
