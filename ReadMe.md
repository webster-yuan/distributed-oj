# distributed-oj
本项目是一个基于 C++ 开发的负载均衡式在线判题系统（Online Judge）。它能够接收用户提交的代码，在后端进行分布式编译和运行，并返回执行结果。

## 项目特点

*   **分布式负载均衡**：`oj_server` 作为任务派发中心，能够动态监控后端多个 `compile_server` 的负载情况（CPU使用率、内存占用等），并根据加权轮询算法将任务分发到最优节点。
*   **后端解耦**：判题逻辑与业务逻辑分离。`compile_server` 专注于代码的编译与运行，`oj_server` 专注于用户交互、题库管理和任务调度。
*   **资源限制与安全**：后端在运行用户代码时，通过 `setrlimit` 等系统调用对 CPU 时间和内存占用进行限制，防止恶意代码消耗系统资源。
*   **完整的业务功能**：支持用户注册、登录（加盐 MD5 加密）、题目 CRUD（增删改查）、答题进度追踪以及管理员后台管理。
*   **MVC 架构**：`oj_server` 内部采用 MVC 模式，利用 `ctemplate` 实现网页的动态渲染。

## 核心模块

### 1. `oj_server` (业务/调度模块)
*   **MVC 模式实现**：
    *   **Model**: 封装与 MySQL 数据库的交互，管理用户信息、题库数据及答题记录。
    *   **View**: 基于 `ctemplate` 渲染 HTML 模板。
    *   **Control**: 业务核心，处理 HTTP 请求，调度负载均衡器。
*   **负载均衡器 (LoadBalance)**：
    *   通过配置文件 `service_machine.conf` 加载后端判题机列表。
    *   实时心跳检测后端机器状态。
    *   根据负载分值（综合 CPU、内存、连接数等）进行智能调度。

### 2. `compile_server` (判题/运行模块)
*   **编译子模块**：使用 `g++` 异步编译用户提交的代码，捕获编译错误。
*   **运行子模块**：通过 `fork` 创建子进程，并利用 `setrlimit` 限制资源，运行编译后的可执行程序。
*   **输出提取**：将标准输出和标准错误重定向到临时文件，解析后返回给调度中心。

## 技术栈

*   **开发语言**：C++ 11
*   **基础组件**：`cpp-httplib` (HTTP 框架), `jsoncpp` (JSON 解析), `ctemplate` (模板引擎)
*   **数据库**：MySQL
*   **安全加密**：MD5 + 盐值加密
*   **操作系统工具**：`fork`, `exec`, `waitpid`, `setrlimit`, `signal`

## 项目目录结构

```text
.
├── comm/                   # 公共工具类（日志、文件操作、字符串处理、网络）
├── compile_server/         # 编译运行后端服务器代码
├── oj_server/              # 业务及负载均衡调度服务器代码
│   ├── conf/               # 配置文件
│   ├── questions/          # 题目数据（本地备份或初始数据）
│   ├── template_html/      # HTML 模板文件
│   └── wwwroot/            # 前端静态资源
├── sql/                    # 数据库建表脚本
├── testCode/               # 各种功能的测试代码
└── makefile                # 项目整体编译脚本
```

## 快速开始

### 1. 依赖安装
确保系统中已安装以下库：
- `g++` (支持 C++11)
- `mysqlclient`
- `jsoncpp`
- `ctemplate`
- `libssl` & `libcrypto` (OpenSSL)

### 2. 数据库配置
执行 `sql/` 目录下的 SQL 脚本以创建所需的表：
```bash
mysql -u root -p < sql/User.sql
mysql -u root -p < sql/question.sql
# ... 依次执行其他脚本
```

### 3. 编译运行
```bash
# 在根目录下直接编译整个项目
make

# 启动后端编译服务 (可以启动多个，修改端口即可)
cd compile_server
./compile_server 8081

# 启动业务及调度中心
cd ../oj_server
./oj_server
```

### 4. 访问
打开浏览器访问 `http://localhost:8180` 即可进入系统。

## 运行环境与调试

### 1. Linux 环境 (推荐)
本项目原生支持 Linux 系统（CentOS/Ubuntu/Debian 等），深度依赖 Linux 的系统调用及 `/proc` 文件系统。
*   **编译**: 直接使用 `make` 指令。
*   **依赖库**: 需安装 `g++`, `libmysqlclient-dev`, `libjsoncpp-dev`, `libctemplate-dev`, `libssl-dev`。
*   **权限**: 确保 `temp/` 目录有写权限，且用户有权限执行 `g++` 命令。

### 2. Windows 10 环境 (WSL2 调试)
本项目**无法原生在 Windows (MSVC/MinGW)** 下编译运行，因为：
1.  使用了 Linux 特有的头文件 `<unistd.h>`, `<sys/sysinfo.h>`, `<sys/resource.h>` 等。
2.  依赖 `/proc` 虚拟文件系统获取系统状态。
3.  判题核心依赖 `fork()` 和 `setrlimit()`。

**推荐方案：使用 WSL2 (Windows Subsystem for Linux)**
1.  在 Windows 商店安装 Ubuntu (或其他发行版)。
2.  在 WSL 环境下按照上述 Linux 步骤安装依赖库。
3.  通过 VSCode 的 `Remote - WSL` 插件进行远程开发和调试。

### 3. 本地 Windows 远程调试云服务器
如果你已经在 Linux 云服务器上运行了项目，可以通过以下方式在本地调试：
- 使用 VSCode 的 `Remote - SSH` 插件连接到云服务器。
- 在本地编辑代码，VSCode 会自动同步到服务器并触发编译运行。

## 面试官视角：如何介绍这个项目

如果你在面试中被问到“请介绍一下你的这个项目”，可以参考以下逻辑进行陈述：

### 1. 项目背景与初衷
“我开发这个项目是为了解决传统单机版 OJ 在面对大流量请求时性能不足的问题。通过分布式设计和负载均衡，系统可以水平扩展判题能力，同时通过底层的沙箱设计保证了运行的安全性。”

### 2. 核心架构（三层模型）
*   **通信层**：基于 `cpp-httplib` 和 `JSON` 实现了轻量级的 RESTful 接口，保证了模块间的高效通信。
*   **调度层 (oj_server)**：这是大脑。它不仅管理业务逻辑（用户、题目），更核心的是它内置了一个**负载均衡器**，能够实时监控后端判题机的‘健康分值’，进行任务的智能派发。
*   **执行层 (compile_server)**：这是执行者。它专注于将代码‘跑起来’。我利用了 Linux 的进程控制和信号处理机制，确保用户代码运行在受控的‘沙箱’环境中。

### 3. 项目的技术亮点（面试重点）
*   **如何防范恶意代码？** 我没有直接运行可执行程序，而是通过 `fork` 创建子进程，并在子进程中使用 `setrlimit` 设置了严格的 CPU 时间和内存上限。即使代码是死循环或内存泄露，也不会拖垮主服务器。
*   **负载均衡是怎么做的？** 我并没有采用简单的轮询，而是实现了一个综合评估模型。我会采集后端的 CPU 使用率、连接数等指标计算出一个权重，优先选择负载最低的节点。同时，我实现了**离线容错机制**，一旦某个后端请求失败，调度中心会立即将其踢出可用列表并尝试重试。
*   **并发安全**：在处理多节点共享资源和生成临时文件时，我使用了原子操作和基于时间戳的唯一 ID 生成策略，确保了在高并发下的数据一致性。

### 4. 总结
“这个项目让我深度实践了 C++ 网络编程、Linux 系统底层接口以及分布式系统的基本设计原则，能够很好地应对中等规模的在线评测需求。”

## 后续优化方向
*   [ ] 引入 Docker 容器化技术进行更彻底的判题隔离。
*   [ ] 支持更多编程语言（Java, Python, Go 等）。
*   [ ] 增加竞赛模式（ACM 模式）。
*   [ ] 优化前端界面，提升用户体验。
